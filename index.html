<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Observability Demo</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Load Configuration First -->
    <script src="config.js"></script>

    <!-- Datadog RUM SDK -->
    <script src="https://www.datadoghq-browser-agent.com/datadog-rum-v4.js" crossorigin="anonymous"></script>
    <script src="https://www.datadoghq-browser-agent.com/datadog-logs-v4.js" crossorigin="anonymous"></script>

    <!-- Initialize Datadog RUM with Hardcoded Configuration -->
    <script>
        (function() {
            // Function to get URL parameters
            function getUrlParameter(name) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(name);
            }

            // Function to get from localStorage with fallback
            function getConfigValue(key, defaultValue) {
                const urlValue = getUrlParameter(key);
                if (urlValue) {
                    localStorage.setItem(key, urlValue);
                    return urlValue;
                }
                return localStorage.getItem(key) || defaultValue;
            }

            // Flexible Datadog RUM configuration with multiple sources
            const DATADOG_CONFIG = {
                // Can be overridden via URL parameters: ?dd_client_token=xxx&dd_app_id=xxx&dd_site=xxx
                clientToken: getConfigValue('dd_client_token', 'pub941f8b1659ac0af8597b9c41a0cfe121'),
                applicationId: getConfigValue('dd_app_id', 'fde3bfb4-cc7c-49ad-82c2-9fed18ce298c'),
                site: getConfigValue('dd_site', 'datadoghq.com'),
                service: getConfigValue('dd_service', 'llm-observability-demo'),
                env: getConfigValue('dd_env', 'production'),
                version: getConfigValue('dd_version', '1.0.0'),
                sessionSampleRate: parseInt(getConfigValue('dd_session_sample_rate', '100')),
                sessionReplaySampleRate: parseInt(getConfigValue('dd_replay_sample_rate', '20')),
                trackUserInteractions: getConfigValue('dd_track_interactions', 'true') === 'true',
                trackResources: getConfigValue('dd_track_resources', 'true') === 'true',
                trackLongTasks: getConfigValue('dd_track_long_tasks', 'true') === 'true',
                defaultPrivacyLevel: getConfigValue('dd_privacy_level', 'mask-user-input')
            };

            // Function to initialize Datadog
            function initializeDatadog() {
                // Check if we have valid tokens (these are real working values)
                const hasValidTokens = DATADOG_CONFIG.clientToken &&
                                     DATADOG_CONFIG.applicationId &&
                                     DATADOG_CONFIG.clientToken.startsWith('pub_') &&
                                     DATADOG_CONFIG.applicationId.length > 0;

                if (!hasValidTokens) {
                    console.warn('‚ö†Ô∏è Datadog tokens not configured - RUM not initialized');
                    console.log('üìù To enable Datadog RUM:');
                    console.log('   1. Get your Client Token from Datadog ‚Üí Organization Settings ‚Üí API Keys');
                    console.log('   2. Get your Application ID from Datadog ‚Üí RUM ‚Üí Applications');
                    console.log('   3. Replace the hardcoded values in index.html');
                    
                    // Create placeholder objects to prevent errors
                    window.DD_RUM = window.DD_RUM || {
                        init: () => {},
                        addAction: () => {},
                        addError: () => {},
                        addTiming: () => {},
                        setGlobalContextProperty: () => {},
                        startSessionReplayRecording: () => {}
                    };
                    window.DD_LOGS = window.DD_LOGS || {
                        init: () => {},
                        logger: {
                            info: () => {},
                            error: () => {},
                            warn: () => {}
                        }
                    };
                    return;
                }

                try {
                    // Initialize RUM
                    if (window.DD_RUM) {
                        window.DD_RUM.init(DATADOG_CONFIG);

                        window.DD_RUM.startSessionReplayRecording();

                        // Set global context
                        window.DD_RUM.setGlobalContextProperty('application_type', 'llm_demo');
                        window.DD_RUM.setGlobalContextProperty('deployment_method', 'static_hosting');
                        window.DD_RUM.setGlobalContextProperty('framework', 'vanilla_js');
                        window.DD_RUM.setGlobalContextProperty('demo_version', '1.0.0');
                    }

                    // Initialize Logs
                    if (window.DD_LOGS) {
                        window.DD_LOGS.init({
                            clientToken: DATADOG_CONFIG.clientToken,
                            site: DATADOG_CONFIG.site,
                            service: DATADOG_CONFIG.service,
                            env: DATADOG_CONFIG.env,
                            version: DATADOG_CONFIG.version,
                            sessionSampleRate: DATADOG_CONFIG.sessionSampleRate,
                            silentMultipleInit: true
                        });
                    }

                        console.log('‚úÖ Datadog RUM and Logs initialized successfully');
                        console.log('üìä RUM Configuration:', {
                            site: DATADOG_CONFIG.site,
                            service: DATADOG_CONFIG.service,
                            env: DATADOG_CONFIG.env,
                            version: DATADOG_CONFIG.version,
                            clientToken: DATADOG_CONFIG.clientToken.substring(0, 10) + '...',
                            applicationId: DATADOG_CONFIG.applicationId.substring(0, 8) + '...'
                        });

                        // Show configuration source
                        const hasUrlParams = window.location.search.includes('dd_');
                        const hasLocalStorage = Object.keys(DATADOG_CONFIG).some(key => 
                            localStorage.getItem('dd_' + key.replace(/([A-Z])/g, '_$1').toLowerCase())
                        );
                        
                        if (hasUrlParams) {
                            console.log('üîß Configuration loaded from URL parameters');
                        } else if (hasLocalStorage) {
                            console.log('üíæ Configuration loaded from localStorage');
                        } else {
                            console.log('üè† Using default hardcoded configuration');
                        }

                    // Track page load
                    if (window.DD_RUM) {
                        window.DD_RUM.addAction('page_loaded', {
                            page_type: 'llm_demo',
                            timestamp: new Date().toISOString(),
                            url: window.location.href,
                            user_agent: navigator.userAgent
                        });
                    }

                } catch (error) {
                    console.error('‚ùå Failed to initialize Datadog:', error);
                }
            }

            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeDatadog);
            } else {
                initializeDatadog();
            }

            // Global functions for configuration management
            window.refreshConfiguration = function() {
                const configDisplay = document.getElementById('current-config');
                if (configDisplay) {
                    configDisplay.innerHTML = `
                        <div class="config-item">
                            <strong>Client Token:</strong> ${DATADOG_CONFIG.clientToken.substring(0, 10)}...
                        </div>
                        <div class="config-item">
                            <strong>Application ID:</strong> ${DATADOG_CONFIG.applicationId.substring(0, 8)}...
                        </div>
                        <div class="config-item">
                            <strong>Site:</strong> ${DATADOG_CONFIG.site}
                        </div>
                        <div class="config-item">
                            <strong>Service:</strong> ${DATADOG_CONFIG.service}
                        </div>
                        <div class="config-item">
                            <strong>Environment:</strong> ${DATADOG_CONFIG.env}
                        </div>
                        <div class="config-item">
                            <strong>Version:</strong> ${DATADOG_CONFIG.version}
                        </div>
                        <div class="config-item">
                            <strong>Session Sample Rate:</strong> ${DATADOG_CONFIG.sessionSampleRate}%
                        </div>
                        <div class="config-item">
                            <strong>Replay Sample Rate:</strong> ${DATADOG_CONFIG.sessionReplaySampleRate}%
                        </div>
                    `;
                }
            };

            window.clearLocalStorage = function() {
                const keys = Object.keys(localStorage).filter(key => key.startsWith('dd_'));
                keys.forEach(key => localStorage.removeItem(key));
                alert('LocalStorage cleared! Refresh the page to use default configuration.');
            };

            window.testDatadogConnection = function() {
                if (window.DD_RUM) {
                    window.DD_RUM.addAction('test_connection', {
                        test_type: 'manual_test',
                        timestamp: new Date().toISOString()
                    });
                    alert('Test action sent to Datadog! Check your RUM dashboard.');
                } else {
                    alert('Datadog RUM not initialized. Check console for errors.');
                }
            };

            // Auto-refresh configuration display when page loads
            setTimeout(() => {
                if (window.refreshConfiguration) {
                    window.refreshConfiguration();
                }
            }, 1000);
        })();
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ LLM Observability Demo</h1>
            <p>Comprehensive monitoring of AI-powered applications with Datadog</p>
        </header>

        <div class="mode-selector">
            <button class="mode-btn active" data-mode="chat">üí¨ Chat</button>
            <button class="mode-btn" data-mode="summarize">üìù Summarize</button>
            <button class="mode-btn" data-mode="codegen">üíª Code Gen</button>
        </div>

        <div class="main-content">
            <div class="chat-container" id="chatMode">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="input-container">
                    <input type="text" id="chatInput" placeholder="Ask me anything..." />
                    <button id="sendBtn">Send</button>
                </div>
            </div>

            <div class="summarize-container hidden" id="summarizeMode">
                <div class="input-section">
                    <h3>Text Summarization</h3>
                    <textarea id="summarizeInput" placeholder="Paste your text here to summarize..."></textarea>
                    <button id="summarizeBtn">Summarize</button>
                </div>
                <div class="output-section">
                    <h3>Summary</h3>
                    <div id="summarizeOutput"></div>
                </div>
            </div>

            <div class="codegen-container hidden" id="codegenMode">
                <div class="input-section">
                    <h3>Code Generation</h3>
                    <textarea id="codegenInput" placeholder="Describe what code you want me to generate..."></textarea>
                    <button id="codegenBtn">Generate Code</button>
                </div>
                <div class="output-section">
                    <h3>Generated Code</h3>
                    <pre id="codegenOutput"></pre>
                </div>
            </div>
        </div>

        <div class="metrics-panel">
            <h3>üìä Session Metrics</h3>
            <div class="metrics-grid">
                <div class="metric">
                    <span class="metric-label">Tokens Used:</span>
                    <span class="metric-value" id="tokenCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Estimated Cost:</span>
                    <span class="metric-value" id="costEstimate">$0.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Requests:</span>
                    <span class="metric-value" id="requestCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Response Time:</span>
                    <span class="metric-value" id="avgResponseTime">0ms</span>
                </div>
            </div>
        </div>

        <div class="config-panel">
            <h3>‚öôÔ∏è Configuration</h3>
            
            <div class="config-section">
                <h4>ü§ñ OpenAI Configuration</h4>
                <div class="config-item">
                    <label for="apiKey">OpenAI API Key:</label>
                    <input type="password" id="apiKey" placeholder="sk-..." />
                </div>
                <div class="config-item">
                    <label for="model">Model:</label>
                    <select id="model">
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>
            </div>

            <div class="config-section">
                <h4>üìä Datadog RUM Configuration</h4>
                <div class="config-info">
                    <p><strong>Current Configuration:</strong></p>
                    <div id="current-config" class="config-display">
                        <p>Loading configuration...</p>
                    </div>
                </div>
                
                <div class="config-methods">
                    <h5>Configuration Methods:</h5>
                    <div class="method">
                        <h6>1. URL Parameters (Recommended for Testing)</h6>
                        <p>Add parameters to the URL to override configuration:</p>
                        <code>?dd_client_token=pub_xxx&dd_app_id=xxx&dd_site=datadoghq.com</code>
                        <div class="url-examples">
                            <p><strong>Examples:</strong></p>
                            <ul>
                                <li><code>?dd_client_token=pub_xxx&dd_app_id=xxx</code> - Override tokens</li>
                                <li><code>?dd_site=datadoghq.eu</code> - Use EU site</li>
                                <li><code>?dd_env=staging&dd_version=2.0.0</code> - Set environment</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="method">
                        <h6>2. Browser localStorage</h6>
                        <p>Values are automatically saved to localStorage when using URL parameters.</p>
                        <button onclick="clearLocalStorage()">Clear Saved Configuration</button>
                    </div>
                    
                    <div class="method">
                        <h6>3. Default Hardcoded Values</h6>
                        <p>Uses safe, publicly exposed demo values if no overrides are provided.</p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="refreshConfiguration()">Refresh Config Display</button>
                    <button onclick="testDatadogConnection()">Test Datadog Connection</button>
                </div>
            </div>

            <div class="config-section">
                <h4>üîß Advanced Datadog Settings</h4>
                <div class="config-item">
                    <label for="ddSessionSampleRate">Session Sample Rate (%):</label>
                    <input type="number" id="ddSessionSampleRate" min="0" max="100" value="100" />
                </div>
                <div class="config-item">
                    <label for="ddReplaySampleRate">Session Replay Sample Rate (%):</label>
                    <input type="number" id="ddReplaySampleRate" min="0" max="100" value="20" />
                </div>
                <div class="config-item">
                    <label>
                        <input type="checkbox" id="ddTrackUserInteractions" checked />
                        Track User Interactions
                    </label>
                </div>
                <div class="config-item">
                    <label>
                        <input type="checkbox" id="ddTrackResources" checked />
                        Track Resources
                    </label>
                </div>
                <div class="config-item">
                    <label>
                        <input type="checkbox" id="ddTrackLongTasks" checked />
                        Track Long Tasks
                    </label>
                </div>
            </div>

            <button id="saveConfig">Save Configuration</button>
            <button id="resetConfig">Reset to Defaults</button>
        </div>
    </div>

    <!-- Load our application scripts -->
    <script src="js/datadog.js"></script>
    <script src="js/openai.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
